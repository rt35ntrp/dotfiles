#!/usr/bin/env bash
# peek: íŒŒì¼ ë‚´ìš©ì„ ìë™ ì¸ì‹í•˜ì—¬ ìš”ì•½/ìƒ˜í”Œì„ ë³´ì—¬ì£¼ëŠ” ì§€ëŠ¥í˜• ë·°ì–´
# ì‚¬ìš©ë²•: peek <file>
set -e

FILE="$1"
[ -z "$FILE" ] && { echo "ì‚¬ìš©ë²•: peek <file>" >&2; exit 1; }
[ ! -f "$FILE" ] && { echo "âš ï¸  íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $FILE" >&2; exit 1; }

EXT="${FILE##*.}"
MIME=$(file --brief --mime-type "$FILE")
SIZE=$(du -h "$FILE" | cut -f1)
LINES=$(wc -l < "$FILE" 2>/dev/null || echo "-")

echo "ğŸ“„ íŒŒì¼: $FILE ($SIZE, $MIME, ${LINES:-?} lines)"

case "$EXT" in
  csv|tsv)
    DELIM=","; [ "$EXT" = "tsv" ] && DELIM=$'\t'
    python3 - <<PY "$FILE" "$DELIM" || true
import sys, csv, itertools, os
path, delim = sys.argv[1], sys.argv[2].encode().decode('unicode_escape')
with open(path, newline='') as f:
    reader = csv.reader(f, delimiter=delim)
    rows = list(itertools.islice(reader, 6))
    col_count = len(rows[0]) if rows else 0
    print(f"í–‰ ìˆ˜(ìƒ˜í”Œ ê¸°ë°˜): {len(rows)}+  ì—´ ìˆ˜: {col_count}")
    print("â”€ ì²« 5ì¤„ â”€")
    for r in rows[:5]:
        print(', '.join(r)[:120])
PY
    ;;
  json)
    echo "ğŸ”‘ ìµœìƒìœ„ í‚¤ ëª©ë¡:"; jq -r 'keys_unsorted[]' "$FILE" | head -20 || true
    echo "â”€ ìƒ˜í”Œ(ì²« 20ì¤„) â”€"; jq '.' "$FILE" | head -20 || head -20 "$FILE"
    ;;
  py)
    echo "ğŸ” í•¨ìˆ˜/í´ë˜ìŠ¤ ì •ì˜:"; grep -En "^ *(def|class) " "$FILE" | head -20 || true
    ;;
  md)
    echo "ğŸ“ Markdown í†µê³„:";
    H=$(grep -c '^#' "$FILE")
    W=$(wc -w < "$FILE")
    echo "í—¤ë”© ê°œìˆ˜: $H, ë‹¨ì–´ ìˆ˜: $W";
    echo "â”€ ì²« 40ì¤„ â”€"; head -40 "$FILE";
    ;;
  log|txt)
    echo "ğŸ“œ ìµœê·¼ 50ì¤„"; tail -50 "$FILE";
    ;;
  pdf)
    if command -v pdfinfo &>/dev/null; then
      pdfinfo "$FILE" | head -20
    else
      echo "pdfinfo ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. brew install poppler ë¡œ ì„¤ì¹˜ ê°€ëŠ¥.";
    fi
    ;;
  png|jpg|jpeg|gif)
    if command -v identify &>/dev/null; then
      identify "$FILE"
    else
      echo "identify (ImageMagick)ê°€ ì—†ìŠµë‹ˆë‹¤. brew install imagemagick ë¡œ ì„¤ì¹˜ ê°€ëŠ¥.";
    fi
    ;;
  parquet|pq)
    # Parquet: pyarrow ì‚¬ìš© ì‹œ ìŠ¤í‚¤ë§ˆ/í–‰ìˆ˜/ìƒ˜í”Œ ì¶œë ¥
    python3 - <<'PY' "$FILE" || {
      echo "âš ï¸  pyarrow ëª¨ë“ˆì´ ì—†ì–´ Parquet ë¯¸ë¦¬ë³´ê¸°ë¥¼ ê±´ë„ˆëœ¹ë‹ˆë‹¤. 'pipx install pyarrow' í˜¹ì€ 'pip install pyarrow' í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
    }
import sys, pyarrow.parquet as pq, pandas as pd
path = sys.argv[1]
pf = pq.ParquetFile(path)
print(f"ì»¬ëŸ¼ ìˆ˜: {len(pf.schema.names)}, ì „ì²´ í–‰ ìˆ˜: {pf.metadata.num_rows}")
df = pq.read_table(path, max_rows=5).to_pandas()
print("â”€ ìƒ˜í”Œ 5ì¤„ â”€")
print(df.to_string(index=False, max_colwidth=30))
PY
    ;;
  *)
    echo "(íŠ¹ìˆ˜ í•¸ë“¤ëŸ¬ ì—†ìŒ) ì²« 40ì¤„:"; head -40 "$FILE";
    ;;
esac 