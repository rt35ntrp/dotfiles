#!/usr/bin/env bash
# tb: TensorBoardë¥¼ íŽ¸ë¦¬í•˜ê²Œ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ëž˜í¼
# ì‚¬ìš©ë²•: tb [logdir] [--port PORT] [--reload]
#   logdir ìƒëžµ ì‹œ í˜„ìž¬ ë””ë ‰í„°ë¦¬ í•˜ìœ„ì—ì„œ runs/, logs/*, lightning_logs/ ì¤‘ ìµœì‹  ë””ë ‰í„°ë¦¬ë¥¼ ìžë™ íƒìƒ‰í•©ë‹ˆë‹¤.
#   --port PORT : ê¸°ë³¸ 6006, ì‚¬ìš© ì¤‘ì´ë©´ ëžœë¤ í¬íŠ¸ ì„ íƒ
#   --reload    : TensorBoard í”„ë¡œì„¸ìŠ¤ê°€ ì´ë¯¸ ìžˆìœ¼ë©´ kill í›„ ìž¬ì‹œìž‘

set -euo pipefail

LOGDIR=""
PORT=6006
RELOAD=false

# ------------ ì¸ìž íŒŒì‹± ------------
while [[ $# -gt 0 ]]; do
  case "$1" in
    --port)
      PORT="$2"; shift 2;;
    --reload)
      RELOAD=true; shift;;
    *)
      if [[ -z "$LOGDIR" ]]; then
        LOGDIR="$1"; shift;
      else
        echo "âš ï¸  ì¸ìžë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”: $1" >&2; exit 1;
      fi;;
  esac
done

# ------------ logdir ìžë™ íƒìƒ‰ ------------
if [[ -z "$LOGDIR" ]]; then
  CANDIDATES=(
    $(find . -type d -maxdepth 2 \( -name 'runs' -o -name 'logs' -o -name 'lightning_logs' \) 2>/dev/null | sort)
  )
  if [[ ${#CANDIDATES[@]} -eq 0 ]]; then
    echo "âš ï¸  logdirë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸ìžë¡œ ëª…ì‹œí•˜ê±°ë‚˜ 'runs/' ë””ë ‰í„°ë¦¬ë¥¼ ìƒì„±í•˜ì„¸ìš”." >&2; exit 1;
  fi
  # ê°€ìž¥ ìµœê·¼ì— ìˆ˜ì •ëœ ë””ë ‰í„°ë¦¬ ì„ íƒ
  LOGDIR=$(ls -td ${CANDIDATES[@]} | head -1)
  echo "â„¹ï¸  ìžë™ ê°ì§€ëœ logdir: $LOGDIR"
fi

# ------------ í¬íŠ¸ í• ë‹¹ ------------
function is_port_free(){ ! lsof -i :$1 &>/dev/null; }
if ! is_port_free "$PORT"; then
  echo "âš ï¸  í¬íŠ¸ $PORT ê°€ ì‚¬ìš© ì¤‘ìž…ë‹ˆë‹¤. ìžìœ  í¬íŠ¸ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤..."
  for p in {7000..7099}; do
    if is_port_free "$p"; then PORT="$p"; break; fi
  done
  echo "â„¹ï¸  í¬íŠ¸ $PORT ì‚¬ìš©"
fi

# ------------ ê¸°ì¡´ TensorBoard ì¢…ë£Œ ------------
if $RELOAD; then
  pkill -f "tensorboard.*--logdir $LOGDIR" 2>/dev/null || true
fi

# ------------ TensorBoard ì‹¤í–‰ ------------
command -v tensorboard >/dev/null 2>&1 || { echo "tensorboard ëª…ë ¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 'pip install tensorboard' í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”." >&2; exit 1; }

echo "ðŸš€ TensorBoard ì‹œìž‘: http://localhost:$PORT (logdir=$LOGDIR)"

tensorboard --logdir "$LOGDIR" --port "$PORT" --host 0.0.0.0 "$@" &
PID=$!

echo "(Ctrl+C ë¡œ ì¤‘ì§€, PID=$PID)"
wait $PID 